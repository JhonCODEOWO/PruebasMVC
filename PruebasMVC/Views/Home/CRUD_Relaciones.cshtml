
@{
    ViewBag.Title = "CRUD_Relaciones";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h1>CRUD_Relaciones</h1>
<p>De la tabla de la <a href="@Url.Action("CRUD", "Home")">primera práctica</a> se ha creado otra con el nombre de "Objeto", intentando simular la propiedad de un objeto hacia una persona, el query para esta tabla lo puedesencontrar <a href="https://gist.github.com/JhonCODEOWO/37ebe0413cd44b015cb945922fe417ac">aquí</a> cabe resaltar que la tabla es básica, pues solo es para la demostración de manejar el crud de relaciones, igualmente el "UNIQUE"  no es funcional en un ejemplo real, pues objetos pueden haber muchisimos y con diferentes nombres, aún así se colocó para la demostración de como manejar estos valores únicos</p>

<button class='btn btn-success btnEditar' data-bs-toggle='modal' data-bs-target='#nuevoModal'> Añadir nuevo registro </button>

<h2 class="mt-3">Listado de objetos</h2>
<table class="table table-dark mt-4" id="tabla">
    <thead>
        <tr class="text-lg-center">
            <th>ID</th>
            <th>Objeto</th>
            <th>Dueño</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody id="tablaBody" class="text-lg-center">
    </tbody>
</table>

<!-- Modal añadir nuevo -->
<div class="modal fade" id="nuevoModal" tabindex="-1" aria-labelledby="nuevoModal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Añadiendo nuevo elemento</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger" role="alert" id="advertencia">
                    
                </div>

                <form id="formularioNuevo" class="d-flex flex-column">
                    <label for="nombre">Identificación del objeto:</label>
                    <input type="text" id="txtIdObjeto" name="txtIdObjeto" placeholder="Ingresa un código con solo números" />

                    <label for="nombre">Nombre para el objeto:</label>
                    <input type="text" id="txtNombreObjeto" name="txtNombreObjeto" placeholder="Escribe un nombre para el objeto" />

                    <label>Dueño del objeto</label>
                    <select id="selectDueño">
                    </select>

                    <div class="d-flex justify-content-end mt-3">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeModal"> Cerrar </button>
                        <button type="submit" class="btn btn-success" data-bs-toggle="popover" data-bs-title="Popover title" data-bs-content="And here's some amazing content. It's very engaging. Right?"> Envíar datos </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script>
        //Elementos para acceder después
        var advertencia = $('#advertencia');
        advertencia.hide();

        $(document).ready(function (event) {

            obtenerUsuarios();

            $('#formularioNuevo').submit(function (event) {
                event.preventDefault();
                var idObjetoForm = $('#txtIdObjeto').val();
                var nombreObjetoForm = $('#txtNombreObjeto').val();
                var idUsuarioForm = $('#selectDueño').val();

                if (idObjetoForm.trim() == '' || nombreObjetoForm.trim() == '' || idUsuarioForm.trim() == '') {
                    mostrarAdvertencia('Debes llenar todos los datos')
                } else {
                    var objeto = {
                        id: idObjetoForm,
                        nombreObjeto: nombreObjetoForm,
                        usuarioId: idUsuarioForm
                    };

                    console.log(objeto);

                    $.ajax({
                        url: '@Url.Action("AñadirObjeto", "Home")',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ objeto: objeto }),
                        success: function (response) {
                            if (response.success) {
                                console.log("Objeto añadido exitosamente");
                            } else {
                                console.log(response.message);
                                mostrarAdvertencia(response.message);
                            }
                        },
                        error: function (error) {
                            console.log("Error ajax para la petición");
                        }

                    });
                }


            });
        });

        function mostrarAdvertencia(texto) {
            advertencia.show();
            advertencia.text(texto);
            //var intervalo = setInterval(ocultarAdvertencia, 5000);

            setTimeout(function () {
                ocultarAdvertencia();
                //clearInterval(intervalo);
            }, 5000);
        }

        function cargarSelect(arreglo) {
            //Recorre cada elemento asociativo sin entrar a sus propiedades
            for (var clave in arreglo) {
                if (arreglo.hasOwnProperty(clave)) {
                    console.log("Si hubo un hijo del elemento");
                    var option = $("<option></option>");

                    //Guardamos el elemento accedido como una variable para poder acceder manualmente a cada elemento
                    var objetoDato = arreglo[clave];
                    var id = objetoDato['id'];
                    var nombre = objetoDato['nombre'];

                    //Al objeto html creado vamos a añadirle los atributos que deseamos
                    option.text(nombre);
                    option.attr('value', id);

                    //Añadimos al select los elementos
                    $('#selectDueño').append(option);
                }
            }
        }

        function ocultarAdvertencia() {
            advertencia.hide();
        }

        function obtenerUsuarios() {
            $.ajax({
                url: '@Url.Action("mostrarUsuarios", "Home")',
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    if (response.success) {
                        var usuarios = response.data;
                        cargarSelect(usuarios);
                    } else {
                        return null;
                    }
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }

        function obtenerObjetos() {

        }
    </script>
}